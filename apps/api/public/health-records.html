<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Health Records Viewer</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .header {
      background: white;
      border-radius: 16px;
      padding: 30px;
      margin-bottom: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    .header h1 {
      color: #667eea;
      font-size: 32px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .header p {
      color: #666;
      font-size: 16px;
    }

    .back-button {
      display: inline-block;
      background: #667eea;
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      text-decoration: none;
      font-weight: 600;
      margin-top: 15px;
      transition: background 0.3s;
    }

    .back-button:hover {
      background: #5568d3;
    }

    .section {
      background: white;
      border-radius: 16px;
      padding: 30px;
      margin-bottom: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    .section h2 {
      color: #333;
      font-size: 24px;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #667eea;
    }

    .loading {
      text-align: center;
      color: #666;
      padding: 40px;
      font-size: 18px;
    }

    .error {
      background: #fee;
      border: 1px solid #fcc;
      color: #c33;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .patient-info {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .info-card {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      border-left: 4px solid #667eea;
    }

    .info-card strong {
      display: block;
      color: #667eea;
      margin-bottom: 5px;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .info-card span {
      color: #333;
      font-size: 16px;
    }

    .list-item {
      background: #f8f9fa;
      padding: 15px 20px;
      border-radius: 8px;
      margin-bottom: 10px;
      border-left: 4px solid #667eea;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .list-item:hover {
      transform: translateX(5px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .list-item h3 {
      color: #333;
      font-size: 18px;
      margin-bottom: 8px;
    }

    .list-item p {
      color: #666;
      font-size: 14px;
      margin: 4px 0;
    }

    .badge {
      display: inline-block;
      background: #667eea;
      color: white;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      margin-top: 8px;
    }

    .badge.active {
      background: #10b981;
    }

    .badge.inactive {
      background: #9ca3af;
    }

    .empty-state {
      text-align: center;
      color: #999;
      padding: 40px;
      font-style: italic;
    }

    .lab-result {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #f8f9fa;
      padding: 15px 20px;
      border-radius: 8px;
      margin-bottom: 10px;
      border-left: 4px solid #667eea;
    }

    .lab-result .lab-name {
      font-weight: 600;
      color: #333;
      font-size: 16px;
    }

    .lab-result .lab-value {
      font-weight: bold;
      color: #667eea;
      font-size: 18px;
    }

    .lab-result .lab-date {
      color: #999;
      font-size: 14px;
      margin-top: 4px;
    }

    @media (max-width: 768px) {
      body {
        padding: 10px;
      }

      .header, .section {
        padding: 20px;
      }

      .header h1 {
        font-size: 24px;
      }

      .patient-info {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üè• Health Records Viewer</h1>
      <p>Comprehensive view of your health information</p>
      <a href="/my-dashboard.html" class="back-button">‚Üê Back to Dashboard</a>
    </div>

    <div id="errorContainer"></div>

    <!-- Patient Demographics -->
    <div class="section">
      <h2>üë§ Patient Information</h2>
      <div id="patientInfo">
        <div class="loading">Loading patient information...</div>
      </div>
    </div>

    <!-- Medications -->
    <div class="section">
      <h2>üíä Medications</h2>
      <div id="medicationsInfo">
        <div class="loading">Loading medications...</div>
      </div>
    </div>

    <!-- Conditions -->
    <div class="section">
      <h2>ü©∫ Conditions & Diagnoses</h2>
      <div id="conditionsInfo">
        <div class="loading">Loading conditions...</div>
      </div>
    </div>

    <!-- Lab Results -->
    <div class="section">
      <h2>üß™ Lab Results</h2>
      <div id="labsInfo">
        <div class="loading">Loading lab results...</div>
      </div>
    </div>

    <!-- Encounters -->
    <div class="section">
      <h2>üè• Encounters & Visits</h2>
      <div id="encountersInfo">
        <div class="loading">Loading encounters...</div>
      </div>
    </div>
  </div>

  <script>
    // Get connection ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    const connectionId = urlParams.get('connection');

    if (!connectionId) {
      showError('No connection ID provided. Please return to the dashboard and try again.');
    } else {
      // Load all health data
      loadPatientInfo();
      loadMedications();
      loadConditions();
      loadLabs();
      loadEncounters();
    }

    function showError(message) {
      const errorContainer = document.getElementById('errorContainer');
      errorContainer.innerHTML = `<div class="error">‚ùå ${message}</div>`;
    }

    // Load patient demographics
    async function loadPatientInfo() {
      try {
        const response = await fetch(`/api/connection/${connectionId}/patient`);

        if (!response.ok) {
          throw new Error('Failed to load patient information');
        }

        const patient = await response.json();
        const container = document.getElementById('patientInfo');

        // Extract patient data
        const name = patient.name?.[0];
        const fullName = name ? `${name.given?.join(' ')} ${name.family}` : 'Unknown';
        const birthDate = patient.birthDate || 'Unknown';
        const gender = patient.gender || 'Unknown';
        const address = patient.address?.[0];
        const addressStr = address ?
          `${address.line?.join(', ')}, ${address.city}, ${address.state} ${address.postalCode}` :
          'Not available';
        const phone = patient.telecom?.find(t => t.system === 'phone')?.value || 'Not available';
        const email = patient.telecom?.find(t => t.system === 'email')?.value || 'Not available';

        container.innerHTML = `
          <div class="patient-info">
            <div class="info-card">
              <strong>Full Name</strong>
              <span>${fullName}</span>
            </div>
            <div class="info-card">
              <strong>Date of Birth</strong>
              <span>${birthDate}</span>
            </div>
            <div class="info-card">
              <strong>Gender</strong>
              <span>${gender.charAt(0).toUpperCase() + gender.slice(1)}</span>
            </div>
            <div class="info-card">
              <strong>Patient ID</strong>
              <span>${patient.id}</span>
            </div>
            <div class="info-card">
              <strong>Phone</strong>
              <span>${phone}</span>
            </div>
            <div class="info-card">
              <strong>Email</strong>
              <span>${email}</span>
            </div>
            <div class="info-card" style="grid-column: 1 / -1;">
              <strong>Address</strong>
              <span>${addressStr}</span>
            </div>
          </div>
        `;
      } catch (error) {
        console.error('Error loading patient info:', error);
        document.getElementById('patientInfo').innerHTML =
          '<div class="error">Failed to load patient information</div>';
      }
    }

    // Load medications
    async function loadMedications() {
      try {
        const response = await fetch(`/api/connection/${connectionId}/medications`);

        if (!response.ok) {
          throw new Error('Failed to load medications');
        }

        const data = await response.json();
        const container = document.getElementById('medicationsInfo');

        if (!data.entry || data.entry.length === 0) {
          container.innerHTML = '<div class="empty-state">No medications found</div>';
          return;
        }

        const medicationsHtml = data.entry.map(entry => {
          const med = entry.resource;
          const medName = med.medicationCodeableConcept?.text ||
                         med.medicationCodeableConcept?.coding?.[0]?.display ||
                         'Unknown medication';
          const status = med.status || 'unknown';
          const authoredOn = med.authoredOn ? new Date(med.authoredOn).toLocaleDateString() : 'Unknown date';
          const dosage = med.dosageInstruction?.[0]?.text || 'No dosage information';

          return `
            <div class="list-item">
              <h3>${medName}</h3>
              <p><strong>Dosage:</strong> ${dosage}</p>
              <p><strong>Prescribed:</strong> ${authoredOn}</p>
              <span class="badge ${status === 'active' ? 'active' : 'inactive'}">${status.toUpperCase()}</span>
            </div>
          `;
        }).join('');

        container.innerHTML = medicationsHtml;
      } catch (error) {
        console.error('Error loading medications:', error);
        document.getElementById('medicationsInfo').innerHTML =
          '<div class="error">Failed to load medications</div>';
      }
    }

    // Load conditions
    async function loadConditions() {
      try {
        const response = await fetch(`/api/connection/${connectionId}/conditions`);

        if (!response.ok) {
          throw new Error('Failed to load conditions');
        }

        const data = await response.json();
        const container = document.getElementById('conditionsInfo');

        if (!data.entry || data.entry.length === 0) {
          container.innerHTML = '<div class="empty-state">No conditions found</div>';
          return;
        }

        const conditionsHtml = data.entry.map(entry => {
          const condition = entry.resource;
          const conditionName = condition.code?.text ||
                               condition.code?.coding?.[0]?.display ||
                               'Unknown condition';
          const clinicalStatus = condition.clinicalStatus?.coding?.[0]?.code || 'unknown';
          const onsetDate = condition.onsetDateTime ?
                           new Date(condition.onsetDateTime).toLocaleDateString() :
                           'Unknown date';

          return `
            <div class="list-item">
              <h3>${conditionName}</h3>
              <p><strong>Onset:</strong> ${onsetDate}</p>
              <span class="badge ${clinicalStatus === 'active' ? 'active' : 'inactive'}">${clinicalStatus.toUpperCase()}</span>
            </div>
          `;
        }).join('');

        container.innerHTML = conditionsHtml;
      } catch (error) {
        console.error('Error loading conditions:', error);
        document.getElementById('conditionsInfo').innerHTML =
          '<div class="error">Failed to load conditions</div>';
      }
    }

    // Load lab results
    async function loadLabs() {
      try {
        const response = await fetch(`/api/connection/${connectionId}/labs`);

        if (!response.ok) {
          throw new Error('Failed to load lab results');
        }

        const data = await response.json();
        const container = document.getElementById('labsInfo');

        if (!data.entry || data.entry.length === 0) {
          container.innerHTML = '<div class="empty-state">No lab results found</div>';
          return;
        }

        const labsHtml = data.entry.map(entry => {
          const lab = entry.resource;
          const labName = lab.code?.text ||
                         lab.code?.coding?.[0]?.display ||
                         'Unknown lab';
          const value = lab.valueQuantity ?
                       `${lab.valueQuantity.value} ${lab.valueQuantity.unit}` :
                       lab.valueString || 'No value';
          const date = lab.effectiveDateTime ?
                      new Date(lab.effectiveDateTime).toLocaleDateString() :
                      'Unknown date';

          return `
            <div class="lab-result">
              <div>
                <div class="lab-name">${labName}</div>
                <div class="lab-date">${date}</div>
              </div>
              <div class="lab-value">${value}</div>
            </div>
          `;
        }).join('');

        container.innerHTML = labsHtml;
      } catch (error) {
        console.error('Error loading labs:', error);
        document.getElementById('labsInfo').innerHTML =
          '<div class="error">Failed to load lab results</div>';
      }
    }

    // Load encounters
    async function loadEncounters() {
      try {
        const response = await fetch(`/api/connection/${connectionId}/encounters`);

        if (!response.ok) {
          throw new Error('Failed to load encounters');
        }

        const data = await response.json();
        const container = document.getElementById('encountersInfo');

        if (!data.entry || data.entry.length === 0) {
          container.innerHTML = '<div class="empty-state">No encounters found</div>';
          return;
        }

        const encountersHtml = data.entry.map(entry => {
          const encounter = entry.resource;
          const type = encounter.type?.[0]?.text ||
                      encounter.type?.[0]?.coding?.[0]?.display ||
                      'Unknown type';
          const status = encounter.status || 'unknown';
          const date = encounter.period?.start ?
                      new Date(encounter.period.start).toLocaleDateString() :
                      'Unknown date';
          const location = encounter.location?.[0]?.location?.display || 'Unknown location';

          return `
            <div class="list-item">
              <h3>${type}</h3>
              <p><strong>Date:</strong> ${date}</p>
              <p><strong>Location:</strong> ${location}</p>
              <span class="badge ${status === 'finished' ? 'inactive' : 'active'}">${status.toUpperCase()}</span>
            </div>
          `;
        }).join('');

        container.innerHTML = encountersHtml;
      } catch (error) {
        console.error('Error loading encounters:', error);
        document.getElementById('encountersInfo').innerHTML =
          '<div class="error">Failed to load encounters</div>';
      }
    }
  </script>
</body>
</html>
